{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Quick Start Buttons -->
    <div class="card">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Quick Start</h2>
                    <p class="text-sm text-gray-500">One-click strategy launch</p>
                </div>
                <div class="flex space-x-3">
                    <button
                        hx-post="/api/v1/trading/quick-start/dutch-book?dry_run=true"
                        hx-swap="none"
                        hx-indicator="#btn-indicator-dutch"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        <span id="btn-indicator-dutch" class="htmx-indicator mr-2">
                            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                        </span>
                        Dutch Book (Dry Run)
                    </button>
                    <button
                        hx-post="/api/v1/trading/quick-start/dutch-book?dry_run=false"
                        hx-swap="none"
                        hx-confirm="Start LIVE trading? Real money will be used."
                        class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                        Dutch Book (Live)
                    </button>
                    <button
                        hx-post="/api/v1/trading/stop"
                        hx-vals='{"reason": "User stopped from dashboard"}'
                        hx-swap="none"
                        class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                        Stop Trading
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Panel -->
    <div id="status-panel"
         hx-get="/partials/status"
         hx-trigger="load, refresh, every 5s"
         hx-swap="innerHTML">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Loading skeleton -->
            <div class="card animate-pulse">
                <div class="card-body">
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                </div>
            </div>
            <div class="card animate-pulse">
                <div class="card-body">
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                </div>
            </div>
            <div class="card animate-pulse">
                <div class="card-body">
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                </div>
            </div>
            <div class="card animate-pulse">
                <div class="card-body">
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Markets Section -->
    <div class="card">
        <div class="card-header flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <span>Upcoming Crypto Markets</span>
                <span class="text-xs text-gray-500">(15m, 30m, 1h windows)</span>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Duration Filter Tabs -->
                <div class="flex space-x-1" id="duration-tabs">
                    <button
                        onclick="filterUpcoming(null)"
                        class="duration-tab px-2 py-1 text-xs font-medium rounded bg-blue-100 text-blue-700"
                        data-duration="all">
                        All
                    </button>
                    <button
                        onclick="filterUpcoming('15m')"
                        class="duration-tab px-2 py-1 text-xs font-medium rounded text-gray-600 hover:bg-gray-100"
                        data-duration="15m">
                        15m
                    </button>
                    <button
                        onclick="filterUpcoming('30m')"
                        class="duration-tab px-2 py-1 text-xs font-medium rounded text-gray-600 hover:bg-gray-100"
                        data-duration="30m">
                        30m
                    </button>
                    <button
                        onclick="filterUpcoming('1h')"
                        class="duration-tab px-2 py-1 text-xs font-medium rounded text-gray-600 hover:bg-gray-100"
                        data-duration="1h">
                        1h
                    </button>
                </div>
                <!-- Asset Filter -->
                <select id="asset-filter" onchange="refreshUpcoming()" class="text-xs border rounded px-2 py-1">
                    <option value="">All Assets</option>
                    <option value="btc">BTC</option>
                    <option value="eth">ETH</option>
                    <option value="sol">SOL</option>
                </select>
                <button
                    hx-get="/partials/upcoming"
                    hx-target="#upcoming-table"
                    hx-swap="innerHTML"
                    class="text-sm text-blue-600 hover:text-blue-800">
                    Refresh
                </button>
            </div>
        </div>
        <div id="upcoming-table"
             hx-get="/partials/upcoming"
             hx-trigger="load, refresh, every 30s"
             hx-swap="innerHTML">
            <div class="p-4 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </div>
    </div>

    <!-- Two column layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Opportunities Table -->
        <div class="card">
            <div class="card-header flex items-center justify-between">
                <span>Live Opportunities</span>
                <button
                    hx-get="/partials/opportunities"
                    hx-target="#opportunities-table"
                    hx-swap="innerHTML"
                    class="text-sm text-blue-600 hover:text-blue-800">
                    Refresh
                </button>
            </div>
            <div id="opportunities-table"
                 hx-get="/partials/opportunities"
                 hx-trigger="load, refresh, every 3s"
                 hx-swap="innerHTML">
                <div class="p-4 flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </div>
        </div>

        <!-- Recent Trades Table -->
        <div class="card">
            <div class="card-header flex items-center justify-between">
                <span>Recent Trades</span>
                <a href="/trades" class="text-sm text-blue-600 hover:text-blue-800">View All</a>
            </div>
            <div id="trades-table"
                 hx-get="/partials/trades"
                 hx-trigger="load, refresh, every 10s"
                 hx-swap="innerHTML">
                <div class="p-4 flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Handle htmx response messages -->
<script>
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        // Parse JSON response if present
        try {
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.message) {
                showNotification(response.message, response.success ? 'success' : 'error');
            }
            // Refresh status panel after trading actions
            if (event.detail.pathInfo.requestPath.includes('/trading/')) {
                htmx.trigger('#status-panel', 'refresh');
            }
        } catch (e) {
            // Not JSON response, ignore
        }
    } else {
        showNotification('Request failed', 'error');
    }
});

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// ============================================================================
// Upcoming Markets - Filters and Countdown
// ============================================================================

let selectedDuration = null;
let countdownInterval = null;

function filterUpcoming(duration) {
    selectedDuration = duration;

    // Update tab styles
    document.querySelectorAll('.duration-tab').forEach(tab => {
        const tabDuration = tab.dataset.duration;
        if ((duration === null && tabDuration === 'all') || tabDuration === duration) {
            tab.classList.remove('text-gray-600', 'hover:bg-gray-100');
            tab.classList.add('bg-blue-100', 'text-blue-700');
        } else {
            tab.classList.remove('bg-blue-100', 'text-blue-700');
            tab.classList.add('text-gray-600', 'hover:bg-gray-100');
        }
    });

    refreshUpcoming();
}

function refreshUpcoming() {
    const asset = document.getElementById('asset-filter').value;
    let url = '/partials/upcoming?windows=3';

    if (selectedDuration) {
        url += `&duration=${selectedDuration}`;
    }
    if (asset) {
        url += `&asset=${asset}`;
    }

    htmx.ajax('GET', url, {target: '#upcoming-table', swap: 'innerHTML'});
}

function selectMarket(slug) {
    // Store selected market and trigger monitor
    console.log('Selecting market:', slug);
    showNotification(`Monitoring: ${slug}`, 'info');
    // Could integrate with trading service here
}

function scheduleAlert(slug, secondsUntil) {
    if (secondsUntil <= 0) {
        showNotification('Market is already open!', 'info');
        return;
    }

    // Simple browser notification alert
    if ('Notification' in window && Notification.permission === 'granted') {
        setTimeout(() => {
            new Notification('Market Opening', {
                body: `${slug} is now accepting orders!`,
                icon: '/static/img/favicon.png'
            });
        }, secondsUntil * 1000);
        showNotification(`Alert set for ${slug}`, 'success');
    } else if ('Notification' in window && Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                scheduleAlert(slug, secondsUntil);
            }
        });
    } else {
        // Fallback to simple timer
        setTimeout(() => {
            showNotification(`${slug} is now open!`, 'info');
        }, secondsUntil * 1000);
        showNotification(`Alert set for ${formatCountdown(secondsUntil)}`, 'success');
    }
}

function formatCountdown(seconds) {
    if (seconds <= 0) return 'NOW';
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
    return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
}

function updateCountdowns() {
    document.querySelectorAll('.countdown').forEach(el => {
        let seconds = parseInt(el.dataset.seconds, 10);
        if (seconds > 0) {
            seconds -= 1;
            el.dataset.seconds = seconds;
            el.textContent = formatCountdown(seconds);

            // Highlight when close to opening
            if (seconds <= 10 && seconds > 0) {
                el.classList.add('text-yellow-600', 'font-bold');
            } else if (seconds <= 0) {
                el.textContent = 'NOW';
                el.classList.remove('text-yellow-600');
                el.classList.add('text-green-600', 'font-bold');
                // Refresh the table when a market opens
                setTimeout(() => refreshUpcoming(), 500);
            }
        }
    });

    // Also update mini countdowns in window info
    document.querySelectorAll('.countdown-mini').forEach(el => {
        let seconds = parseInt(el.dataset.seconds, 10);
        if (seconds > 0) {
            seconds -= 1;
            el.dataset.seconds = seconds;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            el.textContent = `${mins}m ${secs}s`;
        }
    });
}

// Start countdown timer
document.addEventListener('DOMContentLoaded', function() {
    // Update countdowns every second
    countdownInterval = setInterval(updateCountdowns, 1000);

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        // Don't ask immediately, wait for user interaction
    }
});

// Reinitialize countdowns after htmx swaps
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'upcoming-table') {
        // Countdowns will be updated by the interval
    }
});
</script>
{% endblock %}
