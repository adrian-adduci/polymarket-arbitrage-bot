{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Research & Analytics</h1>
        <p class="text-sm text-gray-500">Signals, backtesting, and performance analysis</p>
    </div>

    <!-- P&L Summary -->
    <div class="card">
        <div class="card-header">P&L Summary</div>
        <div id="pnl-summary"
             hx-get="/api/v1/research/pnl"
             hx-trigger="load"
             hx-swap="innerHTML"
             class="card-body">
            <div class="animate-pulse h-24 bg-gray-200 rounded"></div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="card">
        <div class="card-header">Performance Metrics</div>
        <div id="performance-metrics"
             hx-get="/api/v1/research/performance"
             hx-trigger="load"
             hx-swap="innerHTML"
             class="card-body">
            <div class="animate-pulse h-48 bg-gray-200 rounded"></div>
        </div>
    </div>

    <!-- Signals -->
    <div class="card">
        <div class="card-header">Recent Signals</div>
        <div id="signals-table"
             hx-get="/api/v1/research/signals?limit=20"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="p-8 flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </div>
    </div>

    <!-- Backtest Form -->
    <div class="card">
        <div class="card-header">Run Backtest</div>
        <div class="card-body">
            <form id="backtest-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Strategy</label>
                        <select name="strategy" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="dutch-book">Dutch Book</option>
                            <option value="flash-crash">Flash Crash</option>
                            <option value="signals">Signal-Based</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Trade Size ($)</label>
                        <input type="number" name="trade_size" value="10" step="0.01" min="1"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Threshold (%)</label>
                        <input type="number" name="threshold" value="3" step="0.1" min="0" max="100"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <button type="button"
                            onclick="runBacktest()"
                            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <span id="backtest-indicator" class="hidden mr-2">
                            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                        </span>
                        Run Backtest
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Backtest Results -->
    <div id="backtest-results" class="hidden card">
        <div class="card-header">Backtest Results</div>
        <div id="backtest-results-content" class="card-body">
        </div>
    </div>
</div>

<script>
// Handle API responses
document.body.addEventListener('htmx:afterRequest', function(event) {
    const path = event.detail.pathInfo.requestPath;

    try {
        const response = JSON.parse(event.detail.xhr.responseText);
        if (!response.success) return;

        if (path.includes('/pnl')) {
            renderPnLSummary(response.data);
        } else if (path.includes('/performance')) {
            renderPerformanceMetrics(response.data);
        } else if (path.includes('/signals')) {
            renderSignalsTable(response.data);
        }
    } catch (e) {}
});

function renderPnLSummary(data) {
    const container = document.getElementById('pnl-summary');
    container.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <div class="text-sm text-gray-500">Realized P&L</div>
                <div class="text-xl font-bold ${data.realized_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${data.realized_pnl >= 0 ? '+' : ''}$${data.realized_pnl.toFixed(2)}
                </div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Daily P&L</div>
                <div class="text-xl font-bold ${data.daily_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${data.daily_pnl >= 0 ? '+' : ''}$${data.daily_pnl.toFixed(2)}
                </div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Weekly P&L</div>
                <div class="text-xl font-bold ${data.weekly_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${data.weekly_pnl >= 0 ? '+' : ''}$${data.weekly_pnl.toFixed(2)}
                </div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Open Positions</div>
                <div class="text-xl font-bold text-gray-900">$${data.open_position_value.toFixed(2)}</div>
            </div>
        </div>
    `;
}

function renderPerformanceMetrics(data) {
    const container = document.getElementById('performance-metrics');
    container.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div>
                <div class="text-sm text-gray-500">Total Trades</div>
                <div class="text-2xl font-bold text-gray-900">${data.total_trades}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Win Rate</div>
                <div class="text-2xl font-bold text-gray-900">${(data.win_rate * 100).toFixed(1)}%</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Profit Factor</div>
                <div class="text-2xl font-bold ${data.profit_factor >= 1 ? 'text-green-600' : 'text-red-600'}">
                    ${data.profit_factor === Infinity ? 'âˆž' : data.profit_factor.toFixed(2)}
                </div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Avg Trade Duration</div>
                <div class="text-2xl font-bold text-gray-900">${data.avg_trade_duration_hours.toFixed(1)}h</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Avg Profit</div>
                <div class="text-xl font-semibold text-green-600">+$${data.avg_profit.toFixed(2)}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Avg Loss</div>
                <div class="text-xl font-semibold text-red-600">-$${data.avg_loss.toFixed(2)}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Best Trade</div>
                <div class="text-xl font-semibold text-green-600">+$${data.best_trade_pnl.toFixed(2)}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Worst Trade</div>
                <div class="text-xl font-semibold text-red-600">$${data.worst_trade_pnl.toFixed(2)}</div>
            </div>
        </div>
        <div class="mt-6 pt-4 border-t grid grid-cols-2 gap-4">
            <div>
                <div class="text-sm text-gray-500">Max Consecutive Wins</div>
                <div class="text-lg font-semibold text-gray-900">${data.max_consecutive_wins}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Max Consecutive Losses</div>
                <div class="text-lg font-semibold text-gray-900">${data.max_consecutive_losses}</div>
            </div>
        </div>
    `;
}

function renderSignalsTable(signals) {
    const container = document.getElementById('signals-table');
    if (!signals || signals.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-500">No signals recorded</div>';
        return;
    }

    let html = `
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Market</th>
                        <th>Direction</th>
                        <th class="text-right">Strength</th>
                        <th class="text-right">Confidence</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
    `;

    for (const signal of signals) {
        html += `
            <tr>
                <td class="font-medium">${signal.source}</td>
                <td class="max-w-xs truncate">${signal.market_slug}</td>
                <td>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                        ${signal.direction === 'BUY' ? 'bg-green-100 text-green-800' :
                          signal.direction === 'SELL' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                        ${signal.direction}
                    </span>
                </td>
                <td class="text-right">${(signal.strength * 100).toFixed(0)}%</td>
                <td class="text-right">${(signal.confidence * 100).toFixed(0)}%</td>
                <td class="text-xs text-gray-500">${new Date(signal.created_at).toLocaleString()}</td>
            </tr>
        `;
    }

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function runBacktest() {
    const form = document.getElementById('backtest-form');
    const indicator = document.getElementById('backtest-indicator');
    const results = document.getElementById('backtest-results');
    const content = document.getElementById('backtest-results-content');

    const data = {
        strategy: form.querySelector('[name="strategy"]').value,
        trade_size: parseFloat(form.querySelector('[name="trade_size"]').value),
        threshold: parseFloat(form.querySelector('[name="threshold"]').value) / 100
    };

    indicator.classList.remove('hidden');

    try {
        const response = await fetch('/api/v1/research/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            results.classList.remove('hidden');
            renderBacktestResults(result.data);
        } else {
            alert('Backtest failed: ' + (result.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Backtest error: ' + e.message);
    } finally {
        indicator.classList.add('hidden');
    }
}

function renderBacktestResults(data) {
    const container = document.getElementById('backtest-results-content');
    container.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div>
                <div class="text-sm text-gray-500">Total Trades</div>
                <div class="text-xl font-bold text-gray-900">${data.total_trades}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Win Rate</div>
                <div class="text-xl font-bold text-gray-900">${(data.win_rate * 100).toFixed(1)}%</div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Total P&L</div>
                <div class="text-xl font-bold ${data.total_pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${data.total_pnl >= 0 ? '+' : ''}$${data.total_pnl.toFixed(2)}
                </div>
            </div>
            <div>
                <div class="text-sm text-gray-500">Sharpe Ratio</div>
                <div class="text-xl font-bold text-gray-900">${data.sharpe_ratio.toFixed(2)}</div>
            </div>
        </div>
        ${data.trades && data.trades.length > 0 ? `
        <div class="text-sm font-medium text-gray-700 mb-2">Sample Trades (last ${Math.min(data.trades.length, 20)})</div>
        <div class="overflow-x-auto max-h-64">
            <table class="data-table text-sm">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th class="text-right">YES Ask</th>
                        <th class="text-right">NO Ask</th>
                        <th class="text-right">Combined</th>
                        <th class="text-right">Profit</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.trades.slice(-20).reverse().map(t => `
                    <tr>
                        <td class="text-xs">${t.timestamp}</td>
                        <td class="text-right font-mono">$${t.yes_ask.toFixed(4)}</td>
                        <td class="text-right font-mono">$${t.no_ask.toFixed(4)}</td>
                        <td class="text-right font-mono">$${t.combined.toFixed(4)}</td>
                        <td class="text-right text-green-600">+$${t.profit.toFixed(2)}</td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ` : '<div class="text-sm text-gray-500">No simulated trades in backtest period</div>'}
    `;
}
</script>
{% endblock %}
